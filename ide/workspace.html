<!DOCTYPE HTML>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta charset="utf-8" />
		<title>Eclipse Dirigible - Workspace</title>
		<script src="services/message_hub.js"></script>
		<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
		<script src="//ajax.googleapis.com/ajax/libs/angularjs/1.4.7/angular.min.js"></script>
		<script src="//ajax.googleapis.com/ajax/libs/angularjs/1.4.7/angular-resource.min.js"></script>

		<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
		<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/jstree/3.3.3/themes/default/style.min.css" />
		<script src="//cdnjs.cloudflare.com/ajax/libs/jstree/3.3.4/jstree.min.js"></script>
	</head>
	<body style="background-color: #fff" ng-app="workspace" ng-controller="WorkspaceController">
    	<h1>Workspace</h1>
		
		<select ng-model="selectedWs" ng-options="o as o for o in workspaces" ngChange="selected()"></select>
		
		<div class="workspace"></div>		
		
		
		<script>
			var hub2 = new FramesMessageHub({
				topic: 'something',
				targetOrigin: 'http://localhost:8080'
			});
			$('button').click(function(evt){
				hub2.post({data:$('#msg').val()});
			});
			
			var hub = new FramesMessageHub({
				topic: 'fileselected',
				targetOrigin: 'http://localhost:8080'
			});
			$('ul.filelist > li').click(function(evt){
				hub.post({data: JSON.parse($(this).text())});
			});
		</script>
		
		<script type="text/javascript">
			angular.module('workspace', [])
			.controller('WorkspaceController', function ($scope, $http) {
								
				var workspacesSvcUrl = "http://localhost:8080/services/v3/ide/workspaces";
				$scope.selectedWs;
				
				
				this.init = function(){
					$http.get(workspacesSvcUrl)
						.success(function(data) {
							$scope.workspaces = data;
							if(data[0])
								$scope.selectedWs = data[0];
							if($scope.selectedWs){
								$http.get(workspacesSvcUrl + '/' + $scope.selectedWs)
									.success(function(data) {
										$scope.projects = data.projects;
										
										var projects = $scope.projects.map(function(project){
											return build(project);
										})
										$('.workspace').jstree({
											'core' : {
												"themes" : {
												  "variant" : "large"
												},
											  'data' : projects
											}
										  })
										 .on('select_node.jstree', function (e, data) {
											hub.post({data: data.node.original._file});
										  });
								});
							}
					});
				};
				
				var build = function(f){
					var children = [];
					if(f.type=='folder' || f.type=='project'){
						children = f.folders.map(function(_folder){
							return build(_folder)
						});
						var _files = f.files.map(function(_file){
							return build(_file)
						})
						children = children.concat(_files);
					}
					f.label = f.name;
					return {
						"text": f.name,
						"children": children,
						"type": f.type,
						"_file": f,
						"icon": f.type=='file'?'fa fa-file-o':undefined
					}
				}
				
				$scope.selected = function(evt){
					$scope.selectedWs = this;
					$http.get(workspacesSvcUrl + '/' + $scope.selectedWs)
									.success(function(data) {
										$scope.projects = data.projects;
								});
				};
								
				this.init();

			});
			
		</script>
		
	</body>
</html>
