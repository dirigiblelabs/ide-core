<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Eclipse Dirigible &trade;</title>

	<link rel="shortcut icon" type="image/png" href="img/favicon.png" />
	
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
	
	<!-- jQuery -->
	<script src="/services/v3/web/resources/jquery/2.0.3/jquery.min.js"></script>
	
	<!-- Twitter Bootstrap with Theme Support -->
	<link rel="stylesheet" href="/services/v3/core/theme/bootstrap.min.css">
	<script src="/services/v3/web/resources/bootstrap/3.3.7/bootstrap.min.js"></script>
	
	<!-- GoldenLayout with Theme Support -->
	<script type="text/javascript" src="/services/v3/web/resources/goldenlayout/1.5.9/goldenlayout.js"></script>
	<link type="text/css" rel="stylesheet" href="/services/v3/web/resources/goldenlayout/1.5.9/goldenlayout-base.css" />
	<link type="text/css" rel="stylesheet" href="/services/v3/core/theme/goldenlayout-theme.css" />
	
	<!-- Custom IDE Styles -->
	<link type="text/css" rel="stylesheet" href="/services/v3/core/theme/ide.css" />
	
	<script src="ui/message-hub.js"></script>
	
	
    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>

<body ng-app="workbench" ng-controller="WorkbenchController">

	<nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
		<div class="container-flex">
			<div class="navbar-header">
				<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapse">
					<span class="sr-only">Toggle navigation</span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
				</button>
				<a class="navbar-brand" href="#">
					<!-- <img src="img/dirigible.png" style="width: 30px; margin-left: 10px"> -->
					<!-- <i class="logo-icon icon-dirigible" style="color: #ffcc00">&#xe800;</i> -->
					
				</a>
			</div>
			<div class="collapse navbar-collapse" id="navbar-collapse">
				<ul id="main-menu" class="nav navbar-nav">
					<li ng-class="{dropdown: !!menu.items}" ng-repeat="menuItem in menu">
						<a ng-hide="menuItem.items" href="{{menuItem.link}}" ng-click="onClick(menuItem.onClick)" target="{{menuItem.newTab ? '_blank' : '_self'}}">{{ menuItem.name }}</a>
						<a ng-show="menuItem.items" href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">{{ menuItem.name }}</a>
						<ul class="dropdown-menu">
							<li ng-repeat="item in menuItem.items">
								<a ng-hide="item.items" href="{{item.link}}" ng-click="onClick(item.onClick)" target="{{item.newTab ? '_blank' : '_self'}}">{{ item.name }}</a>
								<a ng-show="item.items" href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">{{ item.name }}</a>
								<ul class="dropdown-submenu">
									<li ng-repeat="subItem in item.items">
										<a href="{{subItem.link}}" ng-click="onClick(subItem.onClick)" target="{{subItem.newTab ? '_blank' : '_self'}}">{{ subItem.name }}</a>
									</li>
								</ul>
								
							</li>
						</ul>
					</li>
				</ul>
				<ul class="nav navbar-nav navbar-right">
				  <li class="dropdown" ng-include="'/services/v3/web/resources/themes/themes.html'"></li>
				  <li class="hidden-xs">
					<a href=""><span class="fa fa-user"></span> <span ng-include="'../../js/ide/services/user-name.js'"></span>&nbsp;</a>
				  </li>
				</ul>
			</div>
		</div>
	</nav>
	
	<div class="shell">
		<div class="sidebar list-group">
			<a class="list-group-item" ng-repeat="perspective in perspectives" title="{{perspective.name}}" href="{{perspective.link}}" target="_blank"><i class="fa fa-{{perspective.image}} fa-2x"></i></a>
		</div>
		<div class="plane"></div>
	</div>
	<div class="statusbar"></div>
	
	<!-- AngularJS -->
	<script src="/services/v3/web/resources/angular/1.4.7/angular.min.js"></script>
	<script src="/services/v3/web/resources/angular/1.4.7/angular-resource.min.js"></script>

	<script type="text/javascript">
	
		function ViewRegistry() {
			
			var _views = {};
			
			var _factories = {};
			
			this.factory = function(name, func){
				if(arguments.length == 1)
					return _factories[name];
					
				if(typeof func !== 'function')
					throw Error('Not a function');
				_factories[name] = func;
				return this;
			}
			
			this.factories = function(){
				return _factories;
			}
			
			this.view = function(viewid, factory, region, label, settings){
				if(viewid === undefined)
					throw Error('Illegal argument for viewid ' + viewid);
				//get view
				if(arguments.length == 1)
					return _views[viewid];
				//set view
				if(factory === undefined)
					throw Error('Illegal argument for factory ' + factory);
				var componentName;
				if(typeof factory === 'string')
					componentName = factory;
				else if(typeof factory === 'function'){
					this.factory(viewid, factory);
					componentName = viewid;
				}
				region = region || 'center-bottom';
				settings = settings || [];
				settings.label = label;
				
				_views[viewid] = {
					id: viewid,
					type: 'component',
					componentName: componentName,
					componentState: settings,
					defaultRegionId: region
				}
				return this;
			};
			
			this.views = function(){
				return _views;
			}
			
		};
		
		var viewRegistry = new ViewRegistry();
		
		viewRegistry.factory('frame', function(container, componentState){
			container.setTitle(componentState.label || 'View');
			container.getElement().empty().html( '<iframe src="'+componentState.path+'"></iframe>' );
		})
		.factory('Editor', function(container, componentState){
			this.setContent = function(path){
				if (path) {
					container.getElement().empty().html( '<iframe src="../ide-orion/editor.html?file='+path+'"></iframe>' );
				} else {
					container.setTitle( 'Welcome' );
					container.getElement().empty().html( '<iframe src="welcome.html"></iframe>' );
				}
				
			};
			this.setContent(componentState.path);
		})
		.view('ws', 'frame', 'left-top', 'Workspace',  {path: '../ide-workspace/workspace.html'})
		.view('import', 'frame', 'left-top', 'Import', {path: '../ide-workspace/import.html'})
		.view('editor', 'Editor', 'center-middle', 'Editor', {})
		.view('console', 'frame', 'center-bottom', 'Console', {path: '../ide-console/console.html'})
		.view('preview', 'frame', 'center-bottom', 'Preview', {path: '../ide-preview/preview.html'})
		.view('properties', 'frame', 'center-bottom', 'Properties', {path: '../ide/properties.html'})
		.view('terminal', 'frame', 'center-bottom', 'Terminal', {path: '../ide-terminal/terminal.html'});//.. and so on
	
		function LayoutController(viewRegistry){
		
			this.viewRegistry = viewRegistry;
			
			this.regions = {
				'main': {
					id: 'main',
					type: 'row',
					isClosable: false
				},
				'left': {
					id: 'left',
					type: 'column',
					width: 30,
					defaultRegionId: 'main'
				},
				'left-top': {
					id: 'left-top',
					type: 'stack',
					defaultRegionId: 'left'
				},
				'left-middle': {
					id: 'left-middle',
					type: 'stack',
					defaultRegionId: 'left'
				},
				'left-bottom': {
					id: 'left-bottom',
					type: 'stack',
					defaultRegionId: 'left'
				},
				'center': {
					id: 'center',
					type: 'column',
					defaultRegionId: 'main'
				},
				'center-top': {
					id: 'center-top',				
					type: 'stack',
					defaultRegionId: 'center'
				},
				'center-middle': {
					id: 'center-middle',				
					type: 'stack',
					defaultRegionId: 'center'
				},
				'center-bottom': {
					id: 'center-bottom',				
					type: 'stack',
					defaultRegionId: 'center'
				},
				'right': {
					id: 'right',
					type: 'column',
					defaultRegionId: 'main'
				},
				'right-top': {
					id: 'right-top',
					type: 'stack',
					defaultRegionId: 'right'
				},
				'right-middle': {
					id: 'right-middle',
					type: 'stack',
					defaultRegionId: 'right'
				},
				'right-bottom': {
					id: 'right-bottom',
					type: 'stack',
					defaultRegionId: 'right'
				}
			}
			
			var parentIds = function(node, regionId, arr){
				arr = arr || [];
				var _parentId = regionId || node.defaultRegionId;
				if(!_parentId)
					return arr;
				if(this.regions[_parentId]){
					arr.push(_parentId);
					return parentIds.call(this, this.regions[_parentId], undefined, arr);
				}
				return arr;
			};
			
			var copy = function(src){
				return JSON.parse(JSON.stringify(src));	
			};
			
			var gridItem = function(top, id){
				if(top.id === id)
					return top;
				if(top.content){
					var item = top.content.find(function(_item){
						return gridItem(_item, id);
					});
					return item && gridItem(item, id)
				}
			};
			
			var addView = function(views, view, grid){
				var node;
				var path = [view.id].concat(parentIds.call(this, view));
				//build branches top-bottom				
				path.reverse().forEach(function(compId, idx, arr){
					var _gridNode = gridItem(grid, compId);
					if(_gridNode){
						node = _gridNode;
						return;//next
					} else {
						var child = this.regions[compId] || views[compId];
						if(child){
							child = copy(child);
							if(!node.content)
								node.content = [];	
							if(!node.content.find(function(it){return it.id == child.id}))
								node.content.push(child);
							node = child;
						}
					}
				}.bind(this));
			}.bind(this);
			
			this.layoutViews = function(views){
				var grid = copy(this.regions.main);
				if(views){
					Object.values(views).map(function(view){
						view = copy(view);
						addView(views, view, grid);
						return view;
					}.bind(this));
				}	
				return grid;
			}.bind(this);
			
			this.messageHub = new FramesMessageHub();
			
			this.listeners = {};
			
			this.addListener = function(eventType, callback){
				if(!this.listeners[eventType]){
					this.listeners[eventType] = [];
				}
				var subscriber = this.messageHub.subscribe(callback, eventType);

				var entry = {
					id: uuidv4(),
					handler: subscriber
				};
				this.listeners[eventType].push(entry);
				return entry.id;
			};		
			this.removeListener = function(id, eventType){
				if(!this.listeners[eventType])
					return;
				for (var i = this.listeners[eventType].length - 1; i >= 0; i--) {
				  if (this.listeners[eventType][i].id == id) {
					var subscriber = this.listeners[eventType][i].handler;
				  	this.messageHub.unsibscribe(subscriber);
					this.listeners[eventType].splice(i, 1);
				  }
				}
			};
			
			this.init = function(containerEl, viewNames){
				this.containerEl = containerEl;
				this.viewNames = viewNames;
				
				var views = {};
				viewNames.forEach(function(viewName){
					views[viewName] = this.viewRegistry.view(viewName);
				});
				this.config = {
					dimensions: {
						headerHeight: 26,
						borderWidth: 3
					},
					content: [this.layoutViews.call(this, views)]
				};
				
				var savedState = localStorage.getItem('DIRIGIBLE.IDE.GL.state');
				var cfg = this.config;
				if( savedState !== null ) {
					cfg = JSON.parse(savedState);
				}
				this.layout = new GoldenLayout(cfg, containerEl);
				
				Object.keys(this.viewRegistry.factories()).forEach(function(factoryname){
					this.layout.registerComponent(factoryname, this.viewRegistry.factory(factoryname));
				}.bind(this));
				
				this.layout.on('stateChanged', function(){
					//TODO: debounce or do taht only with save button! This fires a lot
					var state = JSON.stringify( this.layout.toConfig() );
					localStorage.setItem('DIRIGIBLE.IDE.GL.state', state );
				}.bind(this));
				
				this.layout.init();
			};
			
			this.openView = function(viewId/*, region*/){
				var viewDef = this.viewRegistry.view(viewId);
				if(viewDef){
					var node;
					var defaultPath = [viewId];
					defaultPath = defaultPath.concat(parentIds.call(this, viewDef/*, region*/));//TODO: consider custom region
					defaultPath.reverse().forEach(function(compId){
						if(!node)
							node = this.layout.root;
						else
							node = this.layout.root.getItemsById(node.id || node.config.id)[0];
						var child = node.getItemsById(compId)[0] || this.regions[compId] || this.viewRegistry.view(compId);
						if(!node.isRoot && child && this.layout.root.getItemsById(child.id || child.config.id).length<1){
							node.addChild(child);
						}
						node = child;
					}.bind(this));
				}
			};
			
			this.resize = function(){
				this.layout.updateSize();
			};
			
			this.reset = function(){
				this.layout.destroy();
				this.containerEl.empty();
				this.layout.init(this.containerEl, this.viewNames);
			};
		};
		
		function uuidv4() {
		  return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
			(c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
		  )
		}
	
		var layoutCtrl = new LayoutController(viewRegistry);
		
		var wsFileOpenListenerId = layoutCtrl.addListener('workspace.file.open', function(msg){
			var newItemConfig = {
				id: msg.data.path,
				title: msg.data.label,
				type: 'component',
				componentName: 'Editor',
				componentState:{ 
					path: msg.data.path
				}
			};
			//is an editor available to stack new children to it?
			if(layoutCtrl.layout.root.getItemsById('editor')[0]){
				//is already open?
				if(layoutCtrl.layout.root.getItemsById(newItemConfig.id).length){
					//replace content
					var panel = layoutCtrl.layout.root.getItemsById(newItemConfig.id)[0];
					panel.instance.setContent(newItemConfig.id)
					panel.parent.setActiveContentItem(panel);
				} else {
					// open new tab
					layoutCtrl.layout.root.getItemsById('editor')[0].parent.addChild( newItemConfig );
				}
			} else {
				layoutCtrl.openView('editor')
			}
		});
		
		var wsFileDeletedListenerId = layoutCtrl.addListener('workspace.file.deleted', function(msg){
 			//TODO: check if deleted file is currently open in editor and close the editor window
 			console.log('file deleted recieved:'+ msg);
 		});
 				
		var openViewListenerId = layoutCtrl.addListener('ide.perspective.views.open', function(msg){
			var viewId = msg.data.viewId;
			var regionId = msg.data.regionId;
			layoutCtrl.open(viewId, regionId);
		})
 		$(window).resize(function(){layoutCtrl.layout.updateSize()});//TODO: do not expose the native layout object
		layoutCtrl.init($('.plane'), ['ws', 'import', 'editor', 'properties', 'console', 'preview']);
		
	</script>
	
	<script type="text/javascript">
		angular.module('workbench', []);
		angular.module('workbench').controller('WorkbenchController', function ($scope, $http) {
			
			var url = '../../js/ide/services/menu.js';
			$http.get(url)
				.success(function(data) {
					$scope.menu = data;
			});
			
			$scope.onClick = function(action) {
				if(this.item.name === 'Show View'){
					layoutCtrl.openView(this.subItem.name.toLowerCase());
				} else {
					eval(action);
				}
			};
			
			var urlPerspectives = '../../js/ide/services/perspectives.js';
			$http.get(urlPerspectives)
				.success(function(data) {
					$scope.perspectives = data;
			});
		});
	</script>
	
	<script src="/services/v3/web/resources/themes/theme.js"></script>
	
</body>

</html>
